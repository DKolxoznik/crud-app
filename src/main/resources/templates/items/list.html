<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Список записей</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .form-control:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-list-check"></i> Список записей
            <small class="text-muted fs-6">
                (<span th:text="${totalItems}">0</span> записей)
            </small>
        </h1>

        <!-- Блок выбора размера страницы (ВСЕГДА видимый) -->
        <div class="d-flex align-items-center">
            <span class="text-muted me-2">Записей на странице:</span>
            <select class="form-select form-select-sm w-auto"
                    id="pageSizeSelect" onchange="changePageSize(this)">
                <option th:selected="${pageSize == 5}" value="5">5</option>
                <option th:selected="${pageSize == 10}" value="10">10</option>
                <option th:selected="${pageSize == 20}" value="20">20</option>
                <option th:selected="${pageSize == 50}" value="50">50</option>
                <option th:selected="${pageSize == 100}" value="100">100</option>
            </select>

            <!-- Кнопка добавления -->
            <a th:href="@{/items/new}" class="btn btn-success ms-3">
                <i class="bi bi-plus-circle"></i> Добавить
            </a>
        </div>
    </div>

    <!-- ПАНЕЛЬ ПОИСКА И ФИЛЬТРАЦИИ -->
    <div class="card mb-4">
        <div class="card-body">
            <form th:action="@{/items}" method="get" class="row g-3" id="searchForm">
                <!-- Поиск по тексту -->
                <div class="col-md-5">
                    <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                        <input type="text" class="form-control"
                               name="keyword"
                               id="keyword"
                               th:value="${keyword}"
                               placeholder="Поиск по названию или описанию...">
                    </div>
                </div>

                <!-- Фильтр по дате создания -->
                <div class="col-md-4">
                    <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-calendar"></i>
                    </span>
                        <input type="date" class="form-control"
                               name="dateFrom"
                               id="dateFrom"
                               th:value="${dateFrom}"
                               placeholder="Дата создания от...">
                        <!-- Кнопка очистки даты -->
                        <button type="button" class="btn btn-outline-secondary"
                                onclick="clearDateFilter()"
                                th:if="${dateFrom != null}">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>

                <!-- Кнопки -->
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100 me-2">
                        <i class="bi bi-funnel"></i> Применить фильтры
                    </button>
                    <button type="button" class="btn btn-outline-secondary w-100 mt-2"
                            onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Сбросить всё
                    </button>
                </div>

                <!-- Скрытые поля для сохранения состояния -->
                <input type="hidden" name="page" th:value="0">
                <input type="hidden" name="size" th:value="${pageSize}">
                <input type="hidden" name="sort" th:value="${sortField}">
                <input type="hidden" name="dir" th:value="${sortDir}">
            </form>
        </div>
    </div>

    <!-- ТАБЛИЦА -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>
                            <a th:href="@{/items(page=0, size=${pageSize}, sort='name',
                     dir=${sortField == 'name' and sortDir == 'asc' ? 'desc' : 'asc'},
                     keyword=${keyword}, dateFrom=${dateFrom})}">
                                Название
                                <i th:if="${sortField == 'name'}"
                                   th:class="${sortDir == 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'}"></i>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/items(page=0, size=${pageSize}, sort='description',
                     dir=${sortField == 'description' and sortDir == 'asc' ? 'desc' : 'asc'},
                     keyword=${keyword}, dateFrom=${dateFrom})}">
                                Описание
                                <i th:if="${sortField == 'description'}"
                                   th:class="${sortDir == 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'}"></i>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/items(page=0, size=${pageSize}, sort='createdAt',
                     dir=${sortField == 'createdAt' and sortDir == 'asc' ? 'desc' : 'asc'},
                     keyword=${keyword}, dateFrom=${dateFrom})}">
                                Создано
                                <i th:if="${sortField == 'createdAt'}"
                                   th:class="${sortDir == 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'}"></i>
                            </a>
                        </th>
                        <th>
                            <a th:href="@{/items(page=0, size=${pageSize}, sort='updatedAt',
                     dir=${sortField == 'updatedAt' and sortDir == 'asc' ? 'desc' : 'asc'},
                     keyword=${keyword}, dateFrom=${dateFrom})}">
                                Обновлено
                                <i th:if="${sortField == 'updatedAt'}"
                                   th:class="${sortDir == 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down'}"></i>
                            </a>
                        </th>
                        <th class="text-end">Действия</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item : ${itemsPage.content}" th:object="${item}">
                        <td>
                            <strong th:text="*{name}">Название</strong>
                        </td>
                        <td>
                            <span th:text="*{description} ?: '-'">Описание</span>
                        </td>
                        <td>
                                    <span class="text-muted"
                                          th:text="${#temporals.format(item.createdAt, 'yyyy-MM-dd | HH:mm:ss')}">
                                        2025-12-10 | 14:16:13
                                    </span>
                        </td>
                        <td>
                                    <span class="text-muted"
                                          th:if="${item.updatedAt != null}"
                                          th:text="${#temporals.format(item.updatedAt, 'yyyy-MM-dd | HH:mm:ss')}">
                                        2025-12-10 | 14:16:13
                                    </span>
                            <span class="text-muted fst-italic" th:unless="${item.updatedAt != null}">
                                        не изменялось
                                    </span>
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <a th:href="@{/items/edit/{id}(id=${item.id})}"
                                   class="btn btn-outline-primary">
                                    <i class="bi bi-pencil"></i> Изменить
                                </a>
                                <a th:href="@{/items/delete/{id}(id=${item.id})}"
                                   class="btn btn-outline-danger"
                                   onclick="return confirm('Удалить запись &quot;' + [[${item.name}]] + '&quot;?')">
                                    <i class="bi bi-trash"></i> Удалить
                                </a>
                            </div>
                        </td>
                    </tr>

                    <!-- Если записей нет -->
                    <tr th:if="${itemsPage.empty}">
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-6 d-block mb-2"></i>
                            <h5>Записей не найдено</h5>
                            <p class="mb-0">Используйте поиск или добавьте новую запись</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ПАГИНАЦИЯ -->
        <div class="card-footer" th:if="${totalPages > 1}">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Информация о странице -->
                <div class="text-muted">
                    Показано
                    <span th:text="${itemsPage.number * itemsPage.size + 1}">1</span>
                    -
                    <span th:text="${(itemsPage.number + 1) * itemsPage.size > totalItems ? totalItems : (itemsPage.number + 1) * itemsPage.size}">
                            10
                        </span>
                    из <span th:text="${totalItems}">100</span>
                </div>

                <!-- Навигация по страницам -->
                <nav>
                    <ul class="pagination mb-0">
                        <!-- Первая страница -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled' : ''">
                            <a class="page-link"
                               th:href="@{/items(page=0, size=${pageSize}, sort=${sortField}, dir=${sortDir}, keyword=${keyword}, dateFrom=${dateFrom})}">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>

                        <!-- Предыдущая страница -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled' : ''">
                            <a class="page-link"
                               th:href="@{/items(page=${currentPage - 1}, size=${pageSize}, sort=${sortField}, dir=${sortDir}, keyword=${keyword}, dateFrom=${dateFrom})}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>

                        <!-- Номера страниц -->
                        <li class="page-item"
                            th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${pageNum == currentPage} ? 'active' : ''">
                            <a class="page-link"
                               th:href="@{/items(page=${pageNum}, size=${pageSize}, sort=${sortField}, dir=${sortDir}, keyword=${keyword}, dateFrom=${dateFrom})}"
                               th:text="${pageNum + 1}">
                                1
                            </a>
                        </li>

                        <!-- Следующая страница -->
                        <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled' : ''">
                            <a class="page-link"
                               th:href="@{/items(page=${currentPage + 1}, size=${pageSize}, sort=${sortField}, dir=${sortDir}, keyword=${keyword}, dateFrom=${dateFrom})}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>

                        <!-- Последняя страница -->
                        <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled' : ''">
                            <a class="page-link"
                               th:href="@{/items(page=${totalPages - 1}, size=${pageSize}, sort=${sortField}, dir=${sortDir}, keyword=${keyword}, dateFrom=${dateFrom})}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Выбор размера страницы -->
                <div class="d-flex align-items-center">
                    <span class="text-muted me-2">Записей на странице:</span>
                    <select class="form-select form-select-sm w-auto"
                            onchange="changePageSize(this)">
                        <option th:selected="${pageSize == 5}" value="5">5</option>
                        <option th:selected="${pageSize == 10}" value="10">10</option>
                        <option th:selected="${pageSize == 20}" value="20">20</option>
                        <option th:selected="${pageSize == 50}" value="50">50</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3 text-muted small">
        <i class="bi bi-info-circle"></i>
        Текущая сортировка:
        <strong>
        <span th:text="${sortField == 'name' ? 'по названию' :
                         sortField == 'description' ? 'по описанию' :
                         sortField == 'createdAt' ? 'по дате создания' :
                         'по дате обновления'}"></span>
            (<span th:text="${sortDir == 'asc' ? 'А-Я / Старые → Новые' : 'Я-А / Новые → Старые'}"></span>)
        </strong>
    </div>

<script>
    function changePageSize(select) {
        const size = select.value;
        const url = new URL(window.location.href);

        url.searchParams.set('size', size);
        url.searchParams.set('page', '0');

        const sort = document.querySelector('input[name="sort"]')?.value || 'createdAt';
        const dir = document.querySelector('input[name="dir"]')?.value || 'desc';
        const keyword = document.querySelector('input[name="keyword"]')?.value || '';
        const dateFrom = document.querySelector('input[name="dateFrom"]')?.value || '';

        url.searchParams.set('sort', sort);
        url.searchParams.set('dir', dir);
        if (keyword) url.searchParams.set('keyword', keyword);
        if (dateFrom) url.searchParams.set('dateFrom', dateFrom);

        window.location.href = url.toString();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('input[name="keyword"]');
        if (searchInput && !searchInput.value) {
            searchInput.focus();
        }
    });

    function clearDateFilter() {
        document.getElementById('dateFrom').value = '';
        submitSearchForm();
    }

    function clearFilters() {
        document.getElementById('keyword').value = '';
        document.getElementById('dateFrom').value = '';

        const url = new URL(window.location.href);
        url.searchParams.delete('keyword');
        url.searchParams.delete('dateFrom');
        url.searchParams.set('page', '0');
        url.searchParams.set('sort', 'createdAt');
        url.searchParams.set('dir', 'desc');

        window.location.href = url.toString();
    }

    function submitSearchForm() {
        document.getElementById('searchForm').submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('dateFrom');
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                document.querySelector('input[name="page"]').value = '0';
                submitSearchForm();
            });
        }

        showActiveFilters();
    });

    function showActiveFilters() {
        const keyword = document.getElementById('keyword')?.value;
        const dateFrom = document.getElementById('dateFrom')?.value;

        if (keyword || dateFrom) {
            let filters = [];
            if (keyword) filters.push(`Текст: "${keyword}"`);
            if (dateFrom) filters.push(`Дата от: ${dateFrom}`);

            console.log('Активные фильтры:', filters.join(', '));
        }
    }
</script>
</body>
</html>